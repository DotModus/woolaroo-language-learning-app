timeout: 1200s
options:
  machineType: "N1_HIGHCPU_8"
steps:
  # Client
  - id: "install_client_dependencies"
    waitFor: ["run_terraform"]
    name: node:10.16.3
    entrypoint: "npm"
    args: ["install"]
    dir: "./client"
  - id: "download_partner_logo"
    name: gcr.io/cloud-builders/gsutil
    waitFor: ["-"]
    entrypoint: "bash"
    args:
      - "-c"
      - |
        if [ "${_PARTNER_LOGO_URL}" != "" ]
        then
          gsutil cp ${_PARTNER_LOGO_URL} ./src/assets/img/partner_logo.png
        else
          true
        fi
    dir: "./client"
  - id: "configure_client"
    waitFor: ["install_client_dependencies", "download_partner_logo"]
    name: node:10.16.3
    entrypoint: "node"
    args:
      [
        "./configure_client.js",
        "../client/src/environments/environment.prod.params.ts",
        "${_API_URL}",
        "https://storage.googleapis.com/${_BUCKET_NAME}/",
        "${_GOOGLE_TRACKER_ID}",
        "${_LANGUAGE}",
        "${_ENDANGERED_LANGUAGE}",
        "${_TERMS_AND_CONDITIONS}",
        "/assets/img/partner_logo.png",
        "../client/src/style/theme-config.scss",
        "${_THEME}",
      ]
    dir: "./deploy"
  - id: "build_client"
    waitFor: ["configure_client"]
    name: node:10.16.3
    timeout: 1200s
    entrypoint: "npm"
    args:
      [
        "run",
        "build",
        "--",
        "--output-path=./dist",
        "--deploy-url=https://storage.googleapis.com/${_BUCKET_NAME}/",
      ]
    dir: "./client"
  - id: "fix_client_asset_paths"
    waitFor: ["build_client"]
    name: node:10.16.3
    entrypoint: "node"
    args:
      [
        "./fix_asset_paths.js",
        "../client/dist/index.html",
        "https://storage.googleapis.com/${_BUCKET_NAME}",
      ]
    dir: "./deploy"
  - id: "deploy_client"
    waitFor: ["fix_client_asset_paths"]
    name: gcr.io/cloud-builders/gsutil
    args: ["-m", "rsync", "-r", "-c", "-d", "./dist", "gs://${_BUCKET_NAME}"]
    dir: "./client"
  - id: "fix_client_content_types"
    waitFor: ["deploy_client"]
    name: gcr.io/cloud-builders/gsutil
    args:
      [
        "-m",
        "setmeta",
        "-h",
        "Content-Type:text/javascript",
        "gs://${_BUCKET_NAME}/**/*.js",
      ]
  - id: "create_client_cors_config"
    waitFor: ["deploy_client"]
    name: node:10.16.3
    entrypoint: "node"
    args:
      [
        "./create_client_cors_config.js",
        "../client_cors.json",
        "$PROJECT_ID",
        "${_APP_SERVICE}",
        "${_APP_URL}",
      ]
    dir: "./deploy"
  - id: "set_client_cors"
    waitFor: ["create_client_cors_config"]
    name: gcr.io/cloud-builders/gsutil
    args: ["cors", "set", "./client_cors.json", "gs://${_BUCKET_NAME}"]
    dir: "./"
